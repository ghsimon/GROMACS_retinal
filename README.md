# GROMACS umbrella sampling in retinal isomerization

This project contains the code and some of the generated data for umbrella sampling (US) simulations for ground state trans-cis isomerization around the C13=C14 double bond in retinal cofactor attached to a constrained lysine dipeptide.

For details see: [Link to the paper](https://doi.org/10.48550/arXiv.2312.12948).

## Force field and starting structure

The force field files are included in the `amber99sb-star-ildn-retk.ff` folder. Retinal parameters for atomistic force field calculations were taken from DFT studies on the protonated Schiff base taken, [adapted to GROMACS format](http://cmb.bio.uni-goettingen.de/retinal_gromacs.html). The connecting amino acid was modelled using the [AMBER99SB*-ILDN forcefield](https://manual.gromacs.org/documentation/2019/user-guide/force-fields.html). 

Starting structure `6eid_capped_matched.gro` was obtained by cutting out the lysine amino acid and retinal cofactor from a [recent crystal structure](https://www.rcsb.org/structure/6EID), while the ends of the lysine were capped with methyl groups.

Corresponding topology file `topol.top` was generated by GROMACS. Position restraints are given in `posre6.itp` file.

## Generating trajectories

Starting structure is energy minimized using the `minim.mdp` input file, and the resulting structure is used in a series of 125 US windows localized at different values of the C13=C14 dihedral angle. Each window will be biased by a different harmonic restraint, localized at dihedral angles between -3.1 and 3.1 radians in 0.05 radian intervals. 

For each window, a two step NVT equilibration is performed starting from the energy minimized structure. 
- The first NVT equilibration run uses input files `eq1_nvt.mdp` for the dynamics and `eq1_plumed.dat` for the biasing, and is set to use a lower spring constant for the harmonic restraints as to ease the energy minimized structure towards the desired dihedral angle value.
- The second NVT equilibration run used input files `eq2_nvt.mdp` for the dynamics and `eq2_plumed.dat` for the biasing, and is set to use the same spring constant for the harmonic restraints as for the production runs so the simulation is equilibrated for the conditions at which the production runs take place.

Production runs use input files `md.mdp` for dynamics and `plumed.dat` for biasing.

The two step equilibrations and production runs are carried out in the `mult*.sh` scripts in the `mult` directory. In the current implementation, they are done sequentially (though parallellization is straightforward).

## binless WHAM

Trajectories for all windows are concatenated, and weights for the full concatenated trajectory are calculated with respect to each of the 125 independent biasing potentials. This is done in the `conc.sh` and `conc2.sh` scripts in the `conc` directory.

The `run_wham2.py` generates general weights for the concatenated trajectory by performing binless WHAM iterations imported from the `wham.py` script [provided by PLUMED](https://github.com/plumed/masterclass-21-3.git), using the weights calculated for each independent window in the previous step as input.

The general free energy surface (FES) as a function of the dihedral angle can then be calculated from the general weights by PLUMED using the `plumed_multi_discrete.dat` input file.

## Error analysis

Error analysis is done by bootstrapping. The concatenated trajectory is divided in blocks, and bootstrapped trajectories are generated by combining these blocks in random order and allowing repetition. Similarly as before, FES are calculated based on the bootstrapped trajectories. From a large number of such newly generated FES, standard errors can be determined. This is done in the `full_error_discrete.py` script, which imports `wham.py` to perform binless wham and uses the `error_plumed_multi_discrete.dat` PLUMED input file to generate FES.

## Diffusion Profiles

Diffusion profiles are calculated using [Hummer's method](https://iopscience.iop.org/article/10.1088/1367-2630/7/1/034/pdf) by the `calculate_diffusion.py` script in the `Diffusion` directory.

## Command History

A history of the commands used is given in the `history.txt` file.

## Prerequisite Software 

 - GROMACS 2019.6 plugged with PLUMED
 - Python

## Deployment

COLVAR and trajectory files have been deleted.


